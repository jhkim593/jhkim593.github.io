---
layout: post
title: "Kafka - Idempotent Producer (멱등성 프로듀서)"
author: "jhkim593"
tags: Kafka
---
# 멱등성 프로듀서

멱등성이란 여러 번 연산을 수행하더라도 동일한 결과를 나타내는 것을 의미하는데 **멱등성 프로듀서란 동일한 데이터를 여러번 전송하더라도 카프카 브로커에 단 한번만 저장됨을 의미**합니다.

먼저 프로듀서와 브로커간 메세지 전달 방식 세가지에 대해서 알아보겠습니다.

<br>
### 최대 한 번 (At most once)

메시지가 한 번만 전송되며, 재전송은 발생하지 않기 때문에 **메시지가 유실될 수 있는 가능성** 이 있습니다. 다시말해 메세지에 대한 브로커로부터 응답 확인 (acks)을 받지 못하더라도 재전송을 하지않는 것을 의미하며  `acks=0` 설정이 이에 해당합니다.

<br>
### 최소 한 번 (At least once)

메시지가 반드시 전송되지만, 한 번 이상 전송될 수 있기 때문에 **중복 저장이 발생**할 수 있습니다. 예를 들어, 브로커로부터 응답 확인(acks)을 받지 못한 경우, 같은 메시지를 재전송하게 되는데 이때, 브로커가 이미 메시지를 저장했지만 응답을 보내지 않았을 경우, 중복 저장이 발생할 수 있습니다. `acks=1` 설정이 이러한 상황에 해당합니다.

<br>
### 정확히 한 번 (Exactly once)

동일한 메세지를 여러번 전송해도 단 한번만 저장되는 것을 의미하며 메시지가 유실되지 않는 것이 보장됩니다. 카프카에서는 멱등성 프로듀서를 통해 Exactly once를 지원합니다. 아래에서 더 자세히 살펴보도록 하겠습니다.

<br>

# 멱등성 프로듀서 설정

**기본값은 카프카 3.8.0** 기준으로 작성됐습니다.

- enable.idempotence = true (default)
- acks = all ( default)
- retries > 0 (default : 2147483647 )
- max.in.flight.request.per.connection : 1이상 5이하 (default 5)

위의 나열된 설정값이 적용되지 않으면 **`ConfigException`이 발생합니다.**


아래는 카프카 클라이언트 3.8.0 기준 디폴트 설정으로 프로듀서를 실행했을 때 로그입니다.
<img src="/assets/images/33/1.png"  width="700" height="450"/>

<img src="/assets/images/33/2.png"  width="500" height="450"/>

로그를 살펴보면 카프카 클라이언트 3.8.0은 따로 옵션을 설정하지 않아도 기본값을 통해 멱등성 프로듀서로 작동하는 것을 확인할 수 있습니다.

<br>
### **enable.idempotence = true**

설정시 각 프로듀서에 고유한 프로듀서 ID(PID)가 할당되는데 메세지를 보낼때 **PID와 시퀀스 넘버를 함께 브로커로 전달**하게됩니다. 그러면 브로커는 프로듀서의 PID와 시퀀스 넘버를 확인해 **동일한 메세지의 적재 요청이 오더라도 단 한번만 데이터를 적재**함으로써 정확히 한번 브로커에 적재되도록합니다.

PID와 시퀀스 넘버를 통한 처리 과정을 그림 예시를 통해 보도록하겠습니다.

<br>
#### 멱등성 프로듀서가 아닌 경우

<img src="/assets/images/33/3.png"  width="500" height="450"/>

프로듀서가 처음 send 메소드로 메세지를 보냈고 브로커에 저장됐지만 acks를 받지 못했기 때문에 다시 send 메소드를 통해 **메세지가 중복 저장**되게됩니다.

<br>
#### 멱등성 프로듀서인 경우

<img src="/assets/images/33/4.png"  width="500" height="450"/>

프로듀서가 처음 send 메소드로 메세지를 보내고 브로커에 저장됐지만 마찬가지로 acks를 받지 못했기 때문에 다시 send 메소드로 재전송하게됩니다. 하지만 이미 같은 PID , 시퀀스넘버로 메세지가 저장되어있기 때문에 추가로 저장하지 않습니다.

**다시말해 멱등성 프로듀스는 한번 이상 보내지만 한번만 적재되는것을 보장합니다.**

<br>
# 멱등성 프로듀서의 한계

만약 멱등성 프로듀서로 동작하는 프로듀서 어플리케이션에 이슈가 발생해 재시작하게된다면 PID가 달라지게됩니다. **PID가 달라지면 동일한 데이터를 보내더라도 브로커에서는 다른 데이터로 판단하기 때문에 메세지가 중복 저장될 수있습니다.**

다시말해 멱등성 프로듀서는 장애가 발생하지 않을 경우에만 정확히 한번 적재하는것을 보장합니다.

상황에 따라 중복 저장이 될 수 있기 때문에 **컨슈머에서 데이터를 한번만 처리하도록 하는것도 중복 처리 보완 방법으로 고려**해볼 수 있습니다.
